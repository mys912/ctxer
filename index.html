<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CT Report Consistency Checker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .content {
            padding: 30px;
        }
        
        .settings-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .label-with-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #667eea;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .toggle-label {
            font-size: 13px;
            font-weight: 500;
            color: #667eea;
        }
        
        input[type="text"],
        input[type="password"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus,
        input[type="password"]:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        textarea {
            resize: vertical;
            font-family: 'Courier New', monospace;
        }
        
        .textarea-small {
            min-height: 120px;
        }
        
        .textarea-large {
            min-height: 200px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 32px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .results-section {
            margin-top: 30px;
            display: none;
        }
        
        .results-section.visible {
            display: block;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .results-panel {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
        }
        
        .results-panel h3 {
            color: #333;
            font-size: 16px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .copy-btn-small {
            background: #28a745;
            padding: 6px 12px;
            font-size: 12px;
            width: auto;
        }
        
        .copy-btn-small:hover {
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }
        
        .report-display {
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.8;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .analysis-display {
            white-space: pre-wrap;
            font-family: system-ui, -apple-system, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .highlight {
            background-color: #fff3cd;
            border-bottom: 2px solid #ffc107;
            padding: 2px 0;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .highlight:hover {
            background-color: #ffe69c;
        }
        
        .highlight-critical {
            background-color: #f8d7da;
            border-bottom: 2px solid #dc3545;
        }
        
        .highlight-critical:hover {
            background-color: #f1aeb5;
        }
        
        .highlight-suggestion {
            background-color: #d1ecf1;
            border-bottom: 2px solid #17a2b8;
        }
        
        .highlight-suggestion:hover {
            background-color: #b8daff;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #f5c6cb;
            margin-top: 15px;
        }
        
        .hint {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .legend {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            font-size: 12px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-box {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            border: 1px solid #ddd;
        }
        
        @media (max-width: 900px) {
            .results-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• CT Report Consistency Checker</h1>
            <p>Analyze CT reports for consistency using Claude AI</p>
        </div>
        
        <div class="content">
            <div class="settings-section">
                <div class="form-group">
                    <label for="apiKey">Anthropic API Key</label>
                    <input type="password" id="apiKey" placeholder="sk-ant-...">
                    <div class="hint">Your API key is stored locally and never sent anywhere except Anthropic's servers</div>
                </div>
            </div>
            
            <div class="form-group">
                <div class="label-with-toggle">
                    <label for="ctReport">CT Report</label>
                    <div class="toggle-container">
                        <span class="toggle-label">Highlight Mode</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="highlightToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <textarea id="ctReport" class="textarea-large" placeholder="Paste your dictated CT report here..."></textarea>
            </div>
            
            <div class="form-group">
                <label for="history">Patient History</label>
                <textarea id="history" class="textarea-small" placeholder="Enter patient history..."></textarea>
            </div>
            
            <div class="form-group">
                <label for="customInstructions">Custom Instructions (Optional)</label>
                <textarea id="customInstructions" class="textarea-small" placeholder="e.g., 'Focus on checking anatomical consistency' or 'Verify measurement units'"></textarea>
            </div>
            
            <button id="analyzeBtn" onclick="analyzeReport()">Analyze Report</button>
            
            <div id="loadingSection" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Analyzing report with Claude...</p>
            </div>
            
            <div id="resultsSection" class="results-section">
                <div id="highlightLegend" class="legend" style="display: none;">
                    <div class="legend-item">
                        <div class="legend-box" style="background-color: #f8d7da; border-color: #dc3545;"></div>
                        <span>Critical Issue</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background-color: #fff3cd; border-color: #ffc107;"></div>
                        <span>Attention Needed</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background-color: #d1ecf1; border-color: #17a2b8;"></div>
                        <span>Suggestion</span>
                    </div>
                </div>
                
                <div class="results-grid">
                    <div class="results-panel">
                        <h3>
                            <span>Original Report</span>
                            <button class="copy-btn-small" onclick="copyReport()">Copy</button>
                        </h3>
                        <div id="reportDisplay" class="report-display"></div>
                    </div>
                    
                    <div class="results-panel">
                        <h3>
                            <span>Analysis</span>
                            <button class="copy-btn-small" onclick="copyAnalysis()">Copy</button>
                        </h3>
                        <div id="analysisDisplay" class="analysis-display"></div>
                    </div>
                </div>
            </div>
            
            <div id="errorSection" style="display: none;"></div>
        </div>
    </div>

    <script>
        let currentReport = '';
        let highlightData = [];
        
        // Load saved data from localStorage
        window.addEventListener('DOMContentLoaded', () => {
            const savedKey = localStorage.getItem('anthropicApiKey');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
            }
            
            const savedInstructions = localStorage.getItem('customInstructions');
            if (savedInstructions) {
                document.getElementById('customInstructions').value = savedInstructions;
            }
            
            const savedHighlightMode = localStorage.getItem('highlightMode');
            if (savedHighlightMode === 'true') {
                document.getElementById('highlightToggle').checked = true;
            }
        });
        
        // Save custom instructions whenever they change
        document.getElementById('customInstructions').addEventListener('input', (e) => {
            localStorage.setItem('customInstructions', e.target.value);
        });
        
        // Save highlight mode preference
        document.getElementById('highlightToggle').addEventListener('change', (e) => {
            localStorage.setItem('highlightMode', e.target.checked);
        });

        async function analyzeReport() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const ctReport = document.getElementById('ctReport').value.trim();
            const history = document.getElementById('history').value.trim();
            const customInstructions = document.getElementById('customInstructions').value.trim();
            const highlightMode = document.getElementById('highlightToggle').checked;
            
            // Validation
            if (!apiKey) {
                showError('Please enter your Anthropic API key');
                return;
            }
            
            if (!ctReport) {
                showError('Please enter a CT report');
                return;
            }
            
            if (!history) {
                showError('Please enter patient history');
                return;
            }
            
            // Save API key and current report
            localStorage.setItem('anthropicApiKey', apiKey);
            currentReport = ctReport;
            
            // Show loading
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('resultsSection').classList.remove('visible');
            document.getElementById('errorSection').style.display = 'none';
            
            // Build prompt based on mode
            let prompt = `You are a medical AI assistant specializing in radiology report review. Please analyze the following CT report for consistency with the patient history provided.

CT REPORT:
${ctReport}

PATIENT HISTORY:
${history}`;

            if (customInstructions) {
                prompt += `\n\nADDITIONAL INSTRUCTIONS:
${customInstructions}`;
            }

            if (highlightMode) {
                prompt += `\n\nIMPORTANT: You must provide your response in a specific JSON format to enable highlighting of issues in the original report.

Please analyze the report and identify specific text passages that have issues. For each issue, provide:
1. The exact text from the report (must match exactly, including punctuation)
2. The type of issue (critical, attention, or suggestion)
3. A brief explanation of the concern

Return your response as a JSON object with this structure:
{
  "highlights": [
    {
      "text": "exact text from report",
      "type": "critical|attention|suggestion",
      "reason": "explanation of the issue"
    }
  ],
  "summary": "Overall analysis summary with sections for consistency check, discrepancies found, and recommendations"
}

Types:
- critical: Major inconsistencies, contradictions, or safety concerns
- attention: Items needing clarification or verification
- suggestion: Minor improvements or additional considerations`;
            } else {
                prompt += `\n\nPlease check for:
1. Consistency between the findings and the clinical history
2. Internal consistency within the report itself
3. Any discrepancies, contradictions, or areas that need clarification
4. Appropriate correlation of findings with the clinical presentation

Provide a structured analysis with clear sections.`;
            }

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-5-20250929',
                        max_tokens: 4096,
                        messages: [{
                            role: 'user',
                            content: prompt
                        }]
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `API Error: ${response.status}`);
                }
                
                const data = await response.json();
                const result = data.content[0].text;
                
                if (highlightMode) {
                    displayHighlightedResults(result);
                } else {
                    displayStandardResults(result);
                }
                
                document.getElementById('resultsSection').classList.add('visible');
                
            } catch (error) {
                showError(`Error: ${error.message}`);
            } finally {
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('loadingSection').style.display = 'none';
            }
        }
        
        function displayHighlightedResults(result) {
            try {
                // Try to extract JSON from the response
                let jsonMatch = result.match(/\{[\s\S]*"highlights"[\s\S]*\}/);
                if (!jsonMatch) {
                    // Fallback to standard display if JSON not found
                    displayStandardResults(result);
                    return;
                }
                
                const data = JSON.parse(jsonMatch[0]);
                highlightData = data.highlights || [];
                
                // Show legend
                document.getElementById('highlightLegend').style.display = 'flex';
                
                // Display report with highlights
                let highlightedReport = currentReport;
                
                // Sort highlights by length (longest first) to avoid nested replacement issues
                const sortedHighlights = [...highlightData].sort((a, b) => b.text.length - a.text.length);
                
                sortedHighlights.forEach((highlight, index) => {
                    const typeClass = highlight.type === 'critical' ? 'highlight-critical' : 
                                     highlight.type === 'suggestion' ? 'highlight-suggestion' : 
                                     'highlight';
                    const escapedText = highlight.text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    const regex = new RegExp(escapedText, 'g');
                    highlightedReport = highlightedReport.replace(
                        regex, 
                        `<span class="${typeClass}" title="${highlight.reason}">${highlight.text}</span>`
                    );
                });
                
                document.getElementById('reportDisplay').innerHTML = highlightedReport;
                document.getElementById('analysisDisplay').textContent = data.summary || result;
                
            } catch (error) {
                console.error('Error parsing highlight data:', error);
                displayStandardResults(result);
            }
        }
        
        function displayStandardResults(result) {
            document.getElementById('highlightLegend').style.display = 'none';
            document.getElementById('reportDisplay').textContent = currentReport;
            document.getElementById('analysisDisplay').textContent = result;
        }
        
        function showError(message) {
            const errorSection = document.getElementById('errorSection');
            errorSection.innerHTML = `<div class="error">${message}</div>`;
            errorSection.style.display = 'block';
        }
        
        function copyReport() {
            const reportText = currentReport;
            navigator.clipboard.writeText(reportText).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úì Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }
        
        function copyAnalysis() {
            const analysisText = document.getElementById('analysisDisplay').textContent;
            navigator.clipboard.writeText(analysisText).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úì Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }
        
        // Allow Ctrl+Enter in textareas
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.ctrlKey && document.activeElement.tagName === 'TEXTAREA') {
                analyzeReport();
            }
        });
    </script>
</body>
</html>
